#!/usr/bin/env bash

set -e

# Function to get the user's name from git config or use a placeholder
person_name() {
  git config user.name 2>/dev/null || echo '[fullname]'
}

# Function to open a URL in the user's default browser
browse() {
  if [ -n "$BROWSER" ]; then
    "$BROWSER" "$@"
  elif type -p xdg-open &>/dev/null; then
    xdg-open "$@"
  elif type -p wslview &>/dev/null; then
    wslview "$@"
  else
    open "$@"
  fi
}

# Function to get a license's text from GitHub's API
# Requires `curl` and `jq` to be installed
get_license_text() {
  local license_id=$1
  local api_url="https://api.github.com/licenses/${license_id}"
  
  # Fetch the license data from the GitHub API and parse it with jq
  # Note: `jq` is a prerequisite for this script to work.
  curl -s "$api_url" | jq -r '.body'
}

# Function to list available licenses from GitHub's API
# Requires `curl` and `jq` to be installed
list_licenses() {
  local api_url="https://api.github.com/licenses"
  
  # Fetch the list of licenses from the GitHub API and parse it with jq
  curl -s "$api_url" | jq -r '.[].key' | sed 's/^/  /'
}

# Check for required commands: curl and jq
if ! command -v curl &>/dev/null || ! command -v jq &>/dev/null; then
  echo "Error: This script requires 'curl' and 'jq' to be installed." >&2
  echo "Please install them to continue." >&2
  exit 1
fi

# Main script logic
if [ $# -eq 0 ]; then
  {
    echo "Usage: $(basename "$0") <license>"
    echo "       $(basename "$0") --web"
    echo
    echo "Adds a LICENSE file based on the license type you specify."
    echo
    echo "Available licenses:"
    list_licenses
  } >&2
  exit 1
fi

if [ "$1" = "--web" ]; then
  echo "Opening GitHub's new license page in your browser..."
  browse "https://github.com/new/community/license/new"
  exit 0
fi

if [ -e LICENSE ]; then
  echo "'LICENSE' file already exists. Aborting." >&2
  exit 1
fi

license_id="$1"
license_text="$(get_license_text "$license_id")"

# Check if the license text was successfully fetched
if [ -z "$license_text" ]; then
  echo "Error: Could not fetch license text for ID '$license_id'." >&2
  echo "Please check the license ID and your internet connection." >&2
  exit 1
fi

# Substitute placeholders and write to LICENSE file
sed "s/\\[year\\]/$(date '+%Y')/; s/\\[fullname\\]/$(person_name)/" <<<"$license_text" > LICENSE

echo "Successfully created a 'LICENSE' file with the '$license_id' license."
